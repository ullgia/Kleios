@using Kleios.Shared.Models
@using Kleios.Shared.Settings
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Setting.Key" 
                                  Label="Chiave" 
                                  Disabled="true"
                                  Variant="Variant.Outlined"
                                  HelperText="Chiave non modificabile"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Key" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField Value="@Setting.Category" 
                                  Label="Categoria" 
                                  Disabled="true"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Folder" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField Value="@Setting.DataType" 
                                  Label="Tipo di Dato" 
                                  Disabled="true"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.DataObject" />
                </MudItem>
                
                <MudItem xs="12">
                    @if (Setting.DataType == "Boolean")
                    {
                        <MudSwitch @bind-Value="_boolValue" 
                                   Label="Valore" 
                                   Color="Color.Primary" />
                    }
                    else if (Setting.DataType == "Json")
                    {
                        <MudTextField @bind-Value="_model.Value" 
                                      Label="Valore (JSON)" 
                                      Lines="10"
                                      Variant="Variant.Outlined"
                                      HelperText="Modifica il JSON" />
                    }
                    else if (Setting.DataType == "Password")
                    {
                        <MudTextField @bind-Value="_model.Value" 
                                      Label="Nuovo Valore" 
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined"
                                      HelperText="Lascia vuoto per non modificare" />
                    }
                    else if (Setting.DataType == "Integer")
                    {
                        <MudNumericField @bind-Value="_intValue" 
                                         Label="Valore" 
                                         Variant="Variant.Outlined" />
                    }
                    else
                    {
                        <MudTextField @bind-Value="_model.Value" 
                                      Label="Valore" 
                                      Variant="Variant.Outlined" />
                    }
                </MudItem>
                
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Description" 
                                  Label="Descrizione" 
                                  Lines="2"
                                  Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Annulla</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@(!_isValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
            }
            Salva Modifiche
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter]
    public SettingMetadata Setting { get; set; } = null!;
    
    private MudForm _form = null!;
    private bool _isValid;
    private bool _saving;
    private UpdateSettingRequest _model = new();
    private bool _boolValue = false;
    private int _intValue = 0;

    protected override void OnParametersSet()
    {
        _model = new UpdateSettingRequest
        {
            Value = Setting.Value,
            Description = Setting.Description
        };

        // Parse boolean value
        if (Setting.DataType == "Boolean")
        {
            _boolValue = Setting.Value?.ToLower() == "true";
        }

        // Parse integer value
        if (Setting.DataType == "Integer" && int.TryParse(Setting.Value, out var intVal))
        {
            _intValue = intVal;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Submit()
    {
        await _form.Validate();
        
        if (!_isValid)
        {
            Snackbar.Add("Correggi gli errori nel form", Severity.Warning);
            return;
        }

        // Converti valore booleano
        if (Setting.DataType == "Boolean")
        {
            _model.Value = _boolValue.ToString().ToLower();
        }

        // Converti valore intero
        if (Setting.DataType == "Integer")
        {
            _model.Value = _intValue.ToString();
        }

        _saving = true;
        MudDialog.Close(DialogResult.Ok(_model));
    }
}
